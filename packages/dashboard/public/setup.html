<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sonder</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0b;
      --surface: #141416;
      --surface-hover: #1a1a1d;
      --border: #2a2a2d;
      --text: #fafafa;
      --text-muted: #888;
      --accent: #a78bfa;
      --accent-dim: rgba(167, 139, 250, 0.1);
      --success: #4ade80;
      --error: #f87171;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 60px 24px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Steps */
    .step {
      display: none;
      flex-direction: column;
      flex: 1;
      animation: fadeIn 0.4s ease;
    }

    .step.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Typography */
    h1 {
      font-size: 2.5rem;
      font-weight: 600;
      letter-spacing: -0.03em;
      margin-bottom: 16px;
    }

    h2 {
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 12px;
    }

    h3 {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 1.125rem;
      color: var(--text-muted);
      margin-bottom: 40px;
    }

    p {
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .highlight {
      color: var(--accent);
    }

    /* Intro Page */
    .intro-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .intro-content h1 {
      font-size: 3rem;
      margin-bottom: 24px;
    }

    .intro-content .lead {
      font-size: 1.25rem;
      color: var(--text);
      margin-bottom: 32px;
      line-height: 1.7;
    }

    .feature-list {
      margin: 32px 0;
    }

    .feature-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
    }

    .feature-item:last-child {
      border-bottom: none;
    }

    .feature-icon {
      font-size: 1.5rem;
      width: 40px;
      text-align: center;
    }

    .feature-text h4 {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .feature-text p {
      font-size: 0.9rem;
      margin: 0;
    }

    /* Forms */
    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text);
    }

    label small {
      color: var(--text-muted);
      font-weight: 400;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    input.configured {
      border-color: var(--success);
      background: rgba(74, 222, 128, 0.05);
    }

    .input-row {
      display: flex;
      gap: 12px;
    }

    .input-row input {
      flex: 1;
    }

    .test-btn {
      padding: 12px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .test-btn:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
    }

    .test-btn.success {
      border-color: var(--success);
      color: var(--success);
    }

    .test-btn.error {
      border-color: var(--error);
      color: var(--error);
    }

    /* Sections */
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .section-icon {
      font-size: 1.5rem;
    }

    .section-title {
      font-weight: 500;
    }

    .section-badge {
      margin-left: auto;
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      background: var(--accent-dim);
      color: var(--accent);
    }

    .section-badge.optional {
      background: rgba(136, 136, 136, 0.1);
      color: var(--text-muted);
    }

    /* Play Cards */
    .plays-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 32px 0;
    }

    .play-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .play-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .play-card.selected {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .play-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .play-icon {
      font-size: 2.5rem;
    }

    .play-name {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .play-tagline {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .play-description {
      color: var(--text-muted);
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .play-agents {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .agent-tag {
      font-size: 0.8rem;
      padding: 4px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      color: var(--text-muted);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--surface);
      color: var(--text);
    }

    .btn-large {
      padding: 18px 40px;
      font-size: 1.125rem;
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: auto;
      padding-top: 40px;
    }

    /* Progress indicator */
    .progress {
      display: flex;
      gap: 8px;
      margin-bottom: 40px;
    }

    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s;
    }

    .progress-dot.active {
      background: var(--accent);
      width: 24px;
      border-radius: 4px;
    }

    .progress-dot.done {
      background: var(--success);
    }

    /* Collapsible */
    .collapsible {
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .collapsible-header:hover {
      background: var(--surface);
    }

    .collapsible-icon {
      font-size: 1.25rem;
    }

    .collapsible-title {
      flex: 1;
      font-weight: 500;
    }

    .collapsible-status {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .collapsible-status.configured {
      color: var(--success);
    }

    .collapsible-arrow {
      transition: transform 0.2s;
    }

    .collapsible.open .collapsible-arrow {
      transform: rotate(180deg);
    }

    .collapsible-content {
      display: none;
      padding: 0 20px 20px;
    }

    .collapsible.open .collapsible-content {
      display: block;
    }

    /* Status */
    .status-msg {
      font-size: 0.875rem;
      margin-top: 8px;
    }

    .status-msg.success {
      color: var(--success);
    }

    .status-msg.error {
      color: var(--error);
    }

    /* Summary */
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--text-muted);
    }

    .summary-value {
      font-weight: 500;
    }

    .summary-value.configured {
      color: var(--success);
    }

    .summary-value.missing {
      color: var(--text-muted);
    }

    /* Launch */
    .launch-section {
      text-align: center;
      padding: 40px 0;
    }

    .launch-icon {
      font-size: 4rem;
      margin-bottom: 24px;
    }

    .launch-message {
      font-size: 1.125rem;
      color: var(--text-muted);
      margin-bottom: 32px;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Info button & popup */
    .info-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--border);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
      border: none;
      transition: all 0.2s;
    }

    .info-btn:hover {
      background: var(--accent);
      color: #000;
    }

    .info-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      z-index: 1000;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    .info-popup.active {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .info-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }

    .info-overlay.active {
      display: block;
    }

    .info-popup h3 {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-popup ol {
      margin: 0;
      padding-left: 20px;
      color: var(--text-muted);
      line-height: 1.8;
    }

    .info-popup li {
      margin-bottom: 8px;
    }

    .info-popup code {
      background: rgba(255,255,255,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }

    .info-popup .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
    }

    .info-popup .close-btn:hover {
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Step 1: Intro -->
    <div class="step active" id="step-intro">
      <div class="intro-content">
        <h1>Sonder</h1>
        <p class="lead">
          An engine for creating <span class="highlight">AI companions</span> that feel genuinely alive.
          Not assistants that wait for commands‚Äî<em>presences</em> that think, remember, and grow alongside you.
        </p>

        <div class="feature-list">
          <div class="feature-item">
            <div class="feature-icon">üß†</div>
            <div class="feature-text">
              <h4>They think while you're away</h4>
              <p>Companions generate thoughts, reflections, and conversations even when you're not looking.</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üí≠</div>
            <div class="feature-text">
              <h4>They remember everything</h4>
              <p>Every conversation builds shared history. They learn your patterns, preferences, and rhythms.</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üé≠</div>
            <div class="feature-text">
              <h4>Multiple personalities, one experience</h4>
              <p>Each "Play" is a complete cast of characters designed for a specific purpose.</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üè†</div>
            <div class="feature-text">
              <h4>Runs entirely on your machine</h4>
              <p>Local-first. Your data stays yours. Connect your own LLM API.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="nav-buttons">
        <div></div>
        <button class="btn btn-primary btn-large" onclick="nextStep()">
          Get Started
        </button>
      </div>
    </div>

    <!-- Step 2: Configuration -->
    <div class="step" id="step-config">
      <div class="progress">
        <div class="progress-dot done"></div>
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
      </div>

      <h2>Connect your services</h2>
      <p class="subtitle">Sonder needs a few things to run. We'll test each connection as you go.</p>

      <!-- Google Integration (First!) -->
      <div class="section" id="google-section">
        <div class="section-header">
          <span class="section-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle;">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
          </span>
          <span class="section-title">Google Calendar & Gmail</span>
          <span class="section-badge optional">Optional</span>
        </div>

        <!-- Connected state -->
        <div id="google-connected" style="display: none; padding: 16px; background: rgba(74, 222, 128, 0.1); border-radius: 8px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.5rem;">‚úì</span>
            <div>
              <div style="font-weight: 500; color: var(--success);">Connected</div>
              <div id="google-email" style="font-size: 0.9rem; color: var(--text-muted);"></div>
            </div>
            <button onclick="disconnectGoogle()" style="margin-left: auto; background: none; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; color: var(--text-muted); cursor: pointer; font-size: 0.8rem;">
              Disconnect
            </button>
          </div>
        </div>

        <!-- Setup needed -->
        <div id="google-setup">
          <p style="margin-bottom: 16px; font-size: 0.9rem; color: var(--text-muted);">
            Connect your Google account for Calendar, Gmail, and Tasks access.
            Your credentials stay on your machine - fully private.
          </p>

          <!-- Step 1: Create OAuth App -->
          <div id="google-step-1" style="margin-bottom: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
              <strong style="color: var(--text);">Step 1:</strong> Create a Google Cloud OAuth app
              <button class="info-btn" onclick="showInfo('google')" style="margin-left: 4px;">?</button>
            </div>
            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="btn btn-secondary" style="width: 100%; text-decoration: none;">
              Open Google Cloud Console ‚Üí
            </a>
          </div>

          <!-- Step 2: Enter credentials -->
          <div id="google-step-2">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
              <strong style="color: var(--text);">Step 2:</strong> Paste your OAuth credentials
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="font-size: 0.8rem;">Client ID</label>
              <input type="text" id="google-client-id" placeholder="xxxxx.apps.googleusercontent.com">
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="font-size: 0.8rem;">Client Secret</label>
              <input type="password" id="google-client-secret" placeholder="GOCSPX-...">
            </div>
            <button class="btn btn-primary" onclick="saveGoogleCredentials()" style="width: 100%;" id="google-save-btn">
              Save & Connect Google
            </button>
          </div>
        </div>

        <div class="status-msg" id="google-status"></div>
      </div>

      <!-- LLM -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üß†</span>
          <span class="section-title">Language Model</span>
          <span class="section-badge">Required</span>
        </div>

        <div class="form-group">
          <label>Provider</label>
          <select id="llm-provider" onchange="updateLLMFields()">
            <option value="kimi">Kimi (Moonshot AI)</option>
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="ollama">Ollama (Local)</option>
          </select>
        </div>

        <div class="form-group" id="llm-key-group">
          <label>API Key <button class="info-btn" onclick="showInfo('llm')">?</button></label>
          <div class="input-row">
            <input type="password" id="llm-key" placeholder="Enter API key...">
            <button class="test-btn" onclick="testLLM()">Test</button>
          </div>
          <div class="status-msg" id="llm-status"></div>
        </div>
      </div>

      <!-- Telegram -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üí¨</span>
          <span class="section-title">Telegram Bot</span>
          <span class="section-badge">Required</span>
        </div>

        <div class="form-group">
          <label>Bot Token <button class="info-btn" onclick="showInfo('telegram')">?</button></label>
          <div class="input-row">
            <input type="password" id="telegram-token" placeholder="123456789:ABCdefGHI...">
            <button class="test-btn" onclick="testTelegram()">Test</button>
          </div>
          <div class="status-msg" id="telegram-status"></div>
        </div>
      </div>

      <!-- Optional: Email -->
      <div class="collapsible" id="email-section">
        <div class="collapsible-header" onclick="toggleCollapsible('email-section')">
          <span class="collapsible-icon">üìß</span>
          <span class="collapsible-title">Email (Resend)</span>
          <span class="collapsible-status" id="email-collapsible-status">Optional</span>
          <span class="collapsible-arrow">‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="form-group">
            <label>Resend API Key <button class="info-btn" onclick="showInfo('resend')">?</button></label>
            <input type="password" id="resend-key" placeholder="re_...">
          </div>
          <div class="form-group">
            <label>Your Email</label>
            <input type="email" id="user-email" placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label>Sending Domain <small>(verified in Resend)</small></label>
            <input type="text" id="email-domain" placeholder="yourdomain.com">
          </div>
          <button class="test-btn" onclick="testResend()" style="width: 100%;">Test Connection</button>
          <div class="status-msg" id="email-status"></div>
        </div>
      </div>

      <!-- Optional: WhatsApp -->
      <div class="collapsible" id="whatsapp-section">
        <div class="collapsible-header" onclick="toggleCollapsible('whatsapp-section')">
          <span class="collapsible-icon">üì±</span>
          <span class="collapsible-title">WhatsApp (Twilio)</span>
          <span class="collapsible-status" id="whatsapp-collapsible-status">Optional</span>
          <span class="collapsible-arrow">‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="form-group">
            <label>Account SID <button class="info-btn" onclick="showInfo('twilio')">?</button></label>
            <input type="text" id="twilio-sid" placeholder="AC...">
          </div>
          <div class="form-group">
            <label>Auth Token</label>
            <input type="password" id="twilio-token" placeholder="...">
          </div>
          <div class="form-group">
            <label>Twilio WhatsApp Number</label>
            <input type="text" id="twilio-whatsapp" placeholder="+14155238886">
          </div>
          <div class="form-group">
            <label>Your WhatsApp Number</label>
            <input type="text" id="user-whatsapp" placeholder="+1234567890">
          </div>
          <button class="test-btn" onclick="testTwilio()" style="width: 100%;">Test Connection</button>
          <div class="status-msg" id="whatsapp-status"></div>
        </div>
      </div>

      <!-- Optional: Todoist -->
      <div class="collapsible" id="todoist-section">
        <div class="collapsible-header" onclick="toggleCollapsible('todoist-section')">
          <span class="collapsible-icon">‚úÖ</span>
          <span class="collapsible-title">Todoist</span>
          <span class="collapsible-status" id="todoist-collapsible-status">Optional</span>
          <span class="collapsible-arrow">‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="form-group">
            <label>API Key <button class="info-btn" onclick="showInfo('todoist')">?</button></label>
            <div class="input-row">
              <input type="password" id="todoist-key" placeholder="...">
              <button class="test-btn" onclick="testTodoist()">Test</button>
            </div>
            <div class="status-msg" id="todoist-status"></div>
          </div>
        </div>
      </div>

      <!-- Contacts - optional quick setup -->
      <div class="collapsible" id="contacts-section">
        <div class="collapsible-header" onclick="toggleCollapsible('contacts-section')">
          <span class="collapsible-icon">üë•</span>
          <span class="collapsible-title">Key Contacts</span>
          <span class="collapsible-status" id="contacts-collapsible-status">Skip or add</span>
          <span class="collapsible-arrow">‚ñº</span>
        </div>
        <div class="collapsible-content">
          <p style="margin-bottom: 16px; font-size: 0.9rem; color: var(--text-muted);">
            Add a few key people you communicate with often. Sonder will remember them for quick emails and messages.
            You can always add more later just by mentioning them in chat.
          </p>

          <div id="contacts-container">
            <!-- Dynamic contact entries go here -->
          </div>

          <button class="test-btn" onclick="addContactEntry()" style="width: 100%; margin-top: 12px;">
            + Add Contact
          </button>
        </div>
      </div>

      <!-- Optional: Calendar (ICS) - fallback if not using Google -->
      <div class="collapsible" id="calendar-section">
        <div class="collapsible-header" onclick="toggleCollapsible('calendar-section')">
          <span class="collapsible-icon">üìÖ</span>
          <span class="collapsible-title">Calendar (ICS)</span>
          <span class="collapsible-status" id="calendar-collapsible-status">Optional</span>
          <span class="collapsible-arrow">‚ñº</span>
        </div>
        <div class="collapsible-content">
          <p style="margin-bottom: 16px; font-size: 0.9rem;">
            Alternative to Google OAuth. Add calendar feeds manually.
            <button class="info-btn" onclick="event.stopPropagation(); showInfo('calendar')">?</button>
          </p>

          <div id="ics-feeds-container">
            <!-- Dynamic feed entries go here -->
          </div>

          <button class="test-btn" onclick="addICSFeed()" style="width: 100%; margin-top: 12px;">
            + Add Calendar
          </button>
          <div class="status-msg" id="calendar-status"></div>
        </div>
      </div>

      <!-- Timezone -->
      <div class="section" style="padding: 16px 20px;">
        <div class="form-group" style="margin: 0;">
          <label>Your Timezone <span style="color: var(--error);">*</span></label>
          <select id="timezone" required>
            <option value="">Select your timezone...</option>
            <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
            <option value="America/New_York">America/New_York (EST)</option>
            <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
            <option value="Europe/London">Europe/London (GMT)</option>
            <option value="Europe/Paris">Europe/Paris (CET)</option>
            <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
            <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
            <option value="Australia/Sydney">Australia/Sydney (AEDT)</option>
            <option value="UTC">UTC</option>
          </select>
          <div class="status-msg error" id="timezone-error" style="display: none;">Please select your timezone</div>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn btn-primary" onclick="saveConfigAndNext()">Continue</button>
      </div>
    </div>

    <!-- Step 3: Plays Explanation -->
    <div class="step" id="step-plays">
      <div class="progress">
        <div class="progress-dot done"></div>
        <div class="progress-dot done"></div>
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
      </div>

      <h2>Choose your Play</h2>
      <p class="subtitle">A Play is a complete multi-agent experience‚Äîa cast of characters designed for a purpose.</p>

      <div class="plays-grid">
        <div class="play-card" id="play-chorus" onclick="selectPlay('chorus')">
          <div class="play-header">
            <div class="play-icon">üéµ</div>
            <div>
              <div class="play-name">Chorus</div>
              <div class="play-tagline">Five voices harmonizing for your ADHD brain</div>
            </div>
          </div>
          <p class="play-description">
            A support system of five distinct companions, each bringing a different kind of help.
            They coordinate to catch you when you're struggling, celebrate your wins, and gently guide you through difficult moments.
          </p>
          <div class="play-agents">
            <span class="agent-tag">üåô Luna - The Keeper</span>
            <span class="agent-tag">üî• Ember - The Spark</span>
            <span class="agent-tag">üåø Sage - The Guide</span>
            <span class="agent-tag">‚ú® Joy - The Light</span>
            <span class="agent-tag">ü™û Echo - The Mirror</span>
          </div>
        </div>

        <div class="play-card" id="play-wanderers-rest" onclick="selectPlay('wanderers-rest')">
          <div class="play-header">
            <div class="play-icon">üè∞</div>
            <div>
              <div class="play-name">Wanderer's Rest</div>
              <div class="play-tagline">A cozy fantasy tavern to call home</div>
            </div>
          </div>
          <p class="play-description">
            Step into a warm tavern where the innkeeper remembers your name, mysterious travelers share stories,
            and something magical might be brewing in the cellar. A gentle, ongoing narrative experience.
          </p>
          <div class="play-agents">
            <span class="agent-tag">üç∫ Maera - The Innkeeper</span>
            <span class="agent-tag">üó°Ô∏è Roderick - The Sellsword</span>
            <span class="agent-tag">üìö Elara - The Scholar</span>
            <span class="agent-tag">üé≠ Pip - The Trickster</span>
          </div>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn btn-primary" onclick="nextStep()" id="play-continue-btn" disabled>Select a Play to continue</button>
      </div>
    </div>

    <!-- Step 4: Launch -->
    <div class="step" id="step-launch">
      <div class="progress">
        <div class="progress-dot done"></div>
        <div class="progress-dot done"></div>
        <div class="progress-dot done"></div>
        <div class="progress-dot active"></div>
      </div>

      <h2>Ready to launch</h2>
      <p class="subtitle">Here's what you've configured:</p>

      <div class="section">
        <div class="summary-item">
          <span class="summary-label">Play</span>
          <span class="summary-value" id="summary-play">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">LLM Provider</span>
          <span class="summary-value" id="summary-llm">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Telegram</span>
          <span class="summary-value" id="summary-telegram">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Email</span>
          <span class="summary-value" id="summary-email">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">WhatsApp</span>
          <span class="summary-value" id="summary-whatsapp">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Todoist</span>
          <span class="summary-value" id="summary-todoist">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Google</span>
          <span class="summary-value" id="summary-google">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Calendar</span>
          <span class="summary-value" id="summary-calendar">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Contacts</span>
          <span class="summary-value" id="summary-contacts">‚Äî</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Timezone</span>
          <span class="summary-value" id="summary-timezone">‚Äî</span>
        </div>
      </div>

      <div class="launch-section">
        <div class="launch-icon" id="launch-icon">üöÄ</div>
        <p class="launch-message" id="launch-message">
          Configuration saved. Click below to start your companions.
        </p>
        <button class="btn btn-primary btn-large" onclick="launchPlay()" id="launch-btn">
          Launch
        </button>
      </div>

      <div class="nav-buttons">
        <button class="btn btn-secondary" onclick="prevStep()">Back</button>
        <div></div>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 0;
    let selectedPlay = null;
    const steps = ['step-intro', 'step-config', 'step-plays', 'step-launch'];

    // Navigation
    function showStep(index) {
      steps.forEach((id, i) => {
        document.getElementById(id).classList.toggle('active', i === index);
      });
      currentStep = index;
      if (currentStep === steps.length - 1) {
        updateSummary();
      }
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        showStep(currentStep + 1);
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        showStep(currentStep - 1);
      }
    }

    // Collapsible sections
    function toggleCollapsible(id) {
      document.getElementById(id).classList.toggle('open');
    }

    // LLM
    function updateLLMFields() {
      const provider = document.getElementById('llm-provider').value;
      const keyGroup = document.getElementById('llm-key-group');
      keyGroup.style.display = provider === 'ollama' ? 'none' : 'block';
    }

    async function testLLM() {
      const provider = document.getElementById('llm-provider').value;
      const apiKey = document.getElementById('llm-key').value;
      const btn = event.target;
      const status = document.getElementById('llm-status');

      btn.textContent = '...';

      try {
        const res = await fetch('/api/test/llm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider, apiKey })
        });
        const data = await res.json();

        if (data.success) {
          btn.textContent = '‚úì';
          btn.classList.add('success');
          status.textContent = data.message;
          status.className = 'status-msg success';
        } else {
          btn.textContent = '‚úó';
          btn.classList.add('error');
          status.textContent = data.message;
          status.className = 'status-msg error';
        }
      } catch (e) {
        btn.textContent = '‚úó';
        status.textContent = 'Connection failed';
        status.className = 'status-msg error';
      }

      setTimeout(() => {
        btn.textContent = 'Test';
        btn.classList.remove('success', 'error');
      }, 3000);
    }

    async function testTelegram() {
      const token = document.getElementById('telegram-token').value;
      const btn = event.target;
      const status = document.getElementById('telegram-status');

      btn.textContent = '...';

      try {
        const res = await fetch('/api/test/telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await res.json();

        if (data.success) {
          btn.textContent = '‚úì';
          btn.classList.add('success');
          status.textContent = data.message;
          status.className = 'status-msg success';
        } else {
          btn.textContent = '‚úó';
          btn.classList.add('error');
          status.textContent = data.message;
          status.className = 'status-msg error';
        }
      } catch (e) {
        btn.textContent = '‚úó';
        status.textContent = 'Connection failed';
        status.className = 'status-msg error';
      }

      setTimeout(() => {
        btn.textContent = 'Test';
        btn.classList.remove('success', 'error');
      }, 3000);
    }

    async function testResend() {
      const apiKey = document.getElementById('resend-key').value;
      const btn = event.target;
      const status = document.getElementById('email-status');

      btn.textContent = 'Testing...';

      try {
        const res = await fetch('/api/test/resend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey })
        });
        const data = await res.json();

        if (data.success) {
          btn.textContent = '‚úì Connected';
          status.textContent = data.message;
          status.className = 'status-msg success';
          document.getElementById('email-collapsible-status').textContent = 'Configured';
          document.getElementById('email-collapsible-status').classList.add('configured');
        } else {
          btn.textContent = 'Test Connection';
          status.textContent = data.message;
          status.className = 'status-msg error';
        }
      } catch (e) {
        btn.textContent = 'Test Connection';
        status.textContent = 'Connection failed';
        status.className = 'status-msg error';
      }
    }

    async function testTwilio() {
      const accountSid = document.getElementById('twilio-sid').value;
      const authToken = document.getElementById('twilio-token').value;
      const btn = event.target;
      const status = document.getElementById('whatsapp-status');

      btn.textContent = 'Testing...';

      try {
        const res = await fetch('/api/test/twilio', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountSid, authToken })
        });
        const data = await res.json();

        if (data.success) {
          btn.textContent = '‚úì Connected';
          status.textContent = data.message;
          status.className = 'status-msg success';
          document.getElementById('whatsapp-collapsible-status').textContent = 'Configured';
          document.getElementById('whatsapp-collapsible-status').classList.add('configured');
        } else {
          btn.textContent = 'Test Connection';
          status.textContent = data.message;
          status.className = 'status-msg error';
        }
      } catch (e) {
        btn.textContent = 'Test Connection';
        status.textContent = 'Connection failed';
        status.className = 'status-msg error';
      }
    }

    async function testTodoist() {
      const apiKey = document.getElementById('todoist-key').value;
      const btn = event.target;
      const status = document.getElementById('todoist-status');

      btn.textContent = '...';

      try {
        const res = await fetch('/api/test/todoist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey })
        });
        const data = await res.json();

        if (data.success) {
          btn.textContent = '‚úì';
          btn.classList.add('success');
          status.textContent = data.message;
          status.className = 'status-msg success';
          document.getElementById('todoist-collapsible-status').textContent = 'Configured';
          document.getElementById('todoist-collapsible-status').classList.add('configured');
        } else {
          btn.textContent = '‚úó';
          btn.classList.add('error');
          status.textContent = data.message;
          status.className = 'status-msg error';
        }
      } catch (e) {
        btn.textContent = '‚úó';
        status.textContent = 'Connection failed';
        status.className = 'status-msg error';
      }

      setTimeout(() => {
        btn.textContent = 'Test';
        btn.classList.remove('success', 'error');
      }, 3000);
    }

    // ICS Feeds
    let icsFeeds = [];
    let icsFeedCounter = 0;

    function addICSFeed(name = '', url = '') {
      icsFeedCounter++;
      const id = `ics-feed-${icsFeedCounter}`;

      const container = document.getElementById('ics-feeds-container');
      const feedDiv = document.createElement('div');
      feedDiv.id = id;
      feedDiv.className = 'ics-feed-entry';
      feedDiv.style.cssText = 'background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;';

      feedDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="font-weight: 500; font-size: 0.9rem;">Calendar ${icsFeedCounter}</span>
          <button onclick="removeICSFeed('${id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;">√ó</button>
        </div>
        <div class="form-group" style="margin-bottom: 12px;">
          <label style="font-size: 0.8rem;">Name</label>
          <input type="text" id="${id}-name" placeholder="e.g., Work, Personal" value="${name}" onchange="updateICSFeeds()">
        </div>
        <div class="form-group" style="margin-bottom: 8px;">
          <label style="font-size: 0.8rem;">ICS URL</label>
          <input type="url" id="${id}-url" placeholder="https://calendar.google.com/...ics" value="${url}" onchange="updateICSFeeds()">
        </div>
        <button class="test-btn" onclick="testICSFeed('${id}')" style="width: 100%; font-size: 0.8rem; padding: 8px;">Test Feed</button>
        <div class="status-msg" id="${id}-status" style="font-size: 0.8rem;"></div>
      `;

      container.appendChild(feedDiv);
      updateICSFeeds();
      updateCalendarStatus();
    }

    function removeICSFeed(id) {
      document.getElementById(id).remove();
      updateICSFeeds();
      updateCalendarStatus();
    }

    function updateICSFeeds() {
      icsFeeds = [];
      document.querySelectorAll('.ics-feed-entry').forEach((entry, index) => {
        const id = entry.id;
        const name = document.getElementById(`${id}-name`).value;
        const url = document.getElementById(`${id}-url`).value;
        if (name && url) {
          icsFeeds.push({ id: `feed-${index}`, name, url });
        }
      });
    }

    function updateCalendarStatus() {
      const status = document.getElementById('calendar-collapsible-status');
      const count = document.querySelectorAll('.ics-feed-entry').length;
      if (count > 0) {
        status.textContent = `${count} calendar${count > 1 ? 's' : ''}`;
        status.classList.add('configured');
      } else {
        status.textContent = 'Optional';
        status.classList.remove('configured');
      }
    }

    async function testICSFeed(id) {
      const url = document.getElementById(`${id}-url`).value;
      const status = document.getElementById(`${id}-status`);

      if (!url) {
        status.textContent = 'Enter a URL first';
        status.className = 'status-msg error';
        return;
      }

      status.textContent = 'Testing...';
      status.className = 'status-msg';

      try {
        const res = await fetch('/api/test/ics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();

        if (data.success) {
          status.textContent = data.message;
          status.className = 'status-msg success';
        } else {
          status.textContent = data.message;
          status.className = 'status-msg error';
        }
      } catch (e) {
        status.textContent = 'Failed to test feed';
        status.className = 'status-msg error';
      }
    }

    // Contacts
    let contactCounter = 0;

    function addContactEntry(prefill = {}) {
      contactCounter++;
      const id = `contact-${contactCounter}`;

      const container = document.getElementById('contacts-container');
      const contactDiv = document.createElement('div');
      contactDiv.id = id;
      contactDiv.className = 'contact-entry';
      contactDiv.style.cssText = 'background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;';

      contactDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="font-weight: 500; font-size: 0.9rem;">Contact ${contactCounter}</span>
          <button onclick="removeContactEntry('${id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;">√ó</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group" style="margin-bottom: 8px;">
            <label style="font-size: 0.75rem;">Name *</label>
            <input type="text" id="${id}-name" placeholder="John Doe" value="${prefill.name || ''}" style="font-size: 0.9rem; padding: 10px;">
          </div>
          <div class="form-group" style="margin-bottom: 8px;">
            <label style="font-size: 0.75rem;">Category</label>
            <select id="${id}-category" style="font-size: 0.9rem; padding: 10px;">
              <option value="friend" ${prefill.category === 'friend' ? 'selected' : ''}>Friend</option>
              <option value="family" ${prefill.category === 'family' ? 'selected' : ''}>Family</option>
              <option value="business" ${prefill.category === 'business' ? 'selected' : ''}>Business</option>
              <option value="acquaintance" ${prefill.category === 'acquaintance' ? 'selected' : ''}>Acquaintance</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 8px;">
            <label style="font-size: 0.75rem;">Email</label>
            <input type="email" id="${id}-email" placeholder="john@example.com" value="${prefill.email || ''}" style="font-size: 0.9rem; padding: 10px;">
          </div>
          <div class="form-group" style="margin-bottom: 8px;">
            <label style="font-size: 0.75rem;">Phone</label>
            <input type="tel" id="${id}-phone" placeholder="+1234567890" value="${prefill.phone || ''}" style="font-size: 0.9rem; padding: 10px;">
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">How do you know them? <span style="color: var(--text-muted);">(optional)</span></label>
          <input type="text" id="${id}-relationship" placeholder="e.g., college friend, coworker at X, client" value="${prefill.relationship || ''}" style="font-size: 0.9rem; padding: 10px;">
        </div>
      `;

      container.appendChild(contactDiv);
      updateContactsStatus();
    }

    function removeContactEntry(id) {
      document.getElementById(id).remove();
      updateContactsStatus();
    }

    function updateContactsStatus() {
      const status = document.getElementById('contacts-collapsible-status');
      const count = document.querySelectorAll('.contact-entry').length;
      if (count > 0) {
        status.textContent = `${count} contact${count > 1 ? 's' : ''}`;
        status.classList.add('configured');
      } else {
        status.textContent = 'Skip or add';
        status.classList.remove('configured');
      }
    }

    function collectContacts() {
      const contacts = [];
      document.querySelectorAll('.contact-entry').forEach(entry => {
        const id = entry.id;
        const name = document.getElementById(`${id}-name`)?.value?.trim();
        const email = document.getElementById(`${id}-email`)?.value?.trim();
        const phone = document.getElementById(`${id}-phone`)?.value?.trim();
        const category = document.getElementById(`${id}-category`)?.value || 'friend';
        const relationship = document.getElementById(`${id}-relationship`)?.value?.trim();

        if (name) {
          contacts.push({ name, email, phone, category, relationship });
        }
      });
      return contacts;
    }

    // Play selection
    function selectPlay(play) {
      selectedPlay = play;
      document.querySelectorAll('.play-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('play-' + play).classList.add('selected');

      const btn = document.getElementById('play-continue-btn');
      btn.disabled = false;
      btn.textContent = 'Continue';
    }

    // Save config
    async function saveConfigAndNext() {
      // Validate timezone is selected
      const timezone = document.getElementById('timezone').value;
      if (!timezone) {
        document.getElementById('timezone-error').style.display = 'block';
        document.getElementById('timezone').focus();
        return;
      }
      document.getElementById('timezone-error').style.display = 'none';

      const config = {
        llmProvider: document.getElementById('llm-provider').value,
      };

      const provider = config.llmProvider;
      const apiKey = document.getElementById('llm-key').value;

      if (provider === 'kimi' && apiKey) config.kimiApiKey = apiKey;
      if (provider === 'openai' && apiKey) config.openaiApiKey = apiKey;
      if (provider === 'anthropic' && apiKey) config.anthropicApiKey = apiKey;

      const telegramToken = document.getElementById('telegram-token').value;
      if (telegramToken) config.chorusTelegramToken = telegramToken;

      const resendKey = document.getElementById('resend-key').value;
      if (resendKey) config.resendApiKey = resendKey;

      const userEmail = document.getElementById('user-email').value;
      if (userEmail) config.userEmail = userEmail;

      const emailDomain = document.getElementById('email-domain').value;
      if (emailDomain) config.emailDomain = emailDomain;

      const twilioSid = document.getElementById('twilio-sid').value;
      if (twilioSid) config.twilioSid = twilioSid;

      const twilioToken = document.getElementById('twilio-token').value;
      if (twilioToken) config.twilioToken = twilioToken;

      const twilioWhatsApp = document.getElementById('twilio-whatsapp').value;
      if (twilioWhatsApp) config.twilioWhatsApp = twilioWhatsApp;

      const userWhatsApp = document.getElementById('user-whatsapp').value;
      if (userWhatsApp) config.userWhatsApp = userWhatsApp;

      const todoistKey = document.getElementById('todoist-key').value;
      if (todoistKey) config.todoistApiKey = todoistKey;

      // ICS Calendars
      updateICSFeeds();
      if (icsFeeds.length > 0) {
        config.icsFeeds = icsFeeds;
      }

      // Contacts
      const contacts = collectContacts();
      if (contacts.length > 0) {
        config.contacts = contacts;
      }

      config.timezone = document.getElementById('timezone').value;

      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });

      nextStep();
    }

    // Summary - check both value and .configured class (for pre-existing secrets)
    function updateSummary() {
      const playNames = {
        'chorus': 'üéµ Chorus',
        'wanderers-rest': 'üè∞ Wanderer\'s Rest'
      };

      document.getElementById('summary-play').textContent = playNames[selectedPlay] || '‚Äî';
      document.getElementById('summary-play').classList.add('configured');

      const provider = document.getElementById('llm-provider').value;
      const providers = { kimi: 'Kimi', openai: 'OpenAI', anthropic: 'Anthropic', ollama: 'Ollama' };
      document.getElementById('summary-llm').textContent = providers[provider] || provider;
      document.getElementById('summary-llm').classList.add('configured');

      const telegramEl = document.getElementById('telegram-token');
      const hasTelegram = telegramEl.value || telegramEl.classList.contains('configured');
      document.getElementById('summary-telegram').textContent = hasTelegram ? 'Configured' : 'Not configured';
      document.getElementById('summary-telegram').classList.toggle('configured', hasTelegram);
      document.getElementById('summary-telegram').classList.toggle('missing', !hasTelegram);

      const emailEl = document.getElementById('resend-key');
      const hasEmail = emailEl.value || emailEl.classList.contains('configured');
      document.getElementById('summary-email').textContent = hasEmail ? 'Configured' : 'Skipped';
      document.getElementById('summary-email').classList.toggle('configured', hasEmail);
      document.getElementById('summary-email').classList.toggle('missing', !hasEmail);

      const whatsappEl = document.getElementById('twilio-sid');
      const hasWhatsapp = whatsappEl.value || whatsappEl.classList.contains('configured');
      document.getElementById('summary-whatsapp').textContent = hasWhatsapp ? 'Configured' : 'Skipped';
      document.getElementById('summary-whatsapp').classList.toggle('configured', hasWhatsapp);
      document.getElementById('summary-whatsapp').classList.toggle('missing', !hasWhatsapp);

      const todoistEl = document.getElementById('todoist-key');
      const hasTodoist = todoistEl.value || todoistEl.classList.contains('configured');
      document.getElementById('summary-todoist').textContent = hasTodoist ? 'Configured' : 'Skipped';
      document.getElementById('summary-todoist').classList.toggle('configured', hasTodoist);
      document.getElementById('summary-todoist').classList.toggle('missing', !hasTodoist);

      // Google status
      const googleConnected = document.getElementById('google-connected').style.display !== 'none';
      const googleEmail = document.getElementById('google-email').textContent;
      document.getElementById('summary-google').textContent = googleConnected ? (googleEmail || 'Connected') : 'Not connected';
      document.getElementById('summary-google').classList.toggle('configured', googleConnected);
      document.getElementById('summary-google').classList.toggle('missing', !googleConnected);

      updateICSFeeds();
      const calCount = icsFeeds.length;
      document.getElementById('summary-calendar').textContent = calCount > 0 ? `${calCount} calendar${calCount > 1 ? 's' : ''}` : (googleConnected ? 'Via Google' : 'Skipped');
      document.getElementById('summary-calendar').classList.toggle('configured', calCount > 0 || googleConnected);
      document.getElementById('summary-calendar').classList.toggle('missing', calCount === 0 && !googleConnected);

      // Contacts
      const contacts = collectContacts();
      const contactCount = contacts.length;
      document.getElementById('summary-contacts').textContent = contactCount > 0 ? `${contactCount} contact${contactCount > 1 ? 's' : ''}` : 'Skipped';
      document.getElementById('summary-contacts').classList.toggle('configured', contactCount > 0);
      document.getElementById('summary-contacts').classList.toggle('missing', contactCount === 0);

      document.getElementById('summary-timezone').textContent = document.getElementById('timezone').value;
    }

    // Launch
    async function launchPlay() {
      const btn = document.getElementById('launch-btn');
      const icon = document.getElementById('launch-icon');
      const msg = document.getElementById('launch-message');

      btn.disabled = true;
      btn.textContent = 'Launching...';
      icon.textContent = '‚è≥';

      // Save play selection
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ play: selectedPlay })
      });

      // Launch
      await fetch('/api/launch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ play: selectedPlay })
      });

      icon.textContent = '‚ú®';
      msg.textContent = 'Your companions are waking up! Check Telegram to start chatting.';
      btn.textContent = 'Running';
      btn.style.background = 'var(--success)';
    }

    // Load existing config on page load
    async function loadExistingConfig() {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();

        if (config.llmProvider) {
          document.getElementById('llm-provider').value = config.llmProvider;
        }

        if (config.llmApiKey === '***configured***') {
          document.getElementById('llm-key').classList.add('configured');
          document.getElementById('llm-key').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (already configured)';
        }

        if (config.telegramToken === '***configured***') {
          document.getElementById('telegram-token').classList.add('configured');
          document.getElementById('telegram-token').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (already configured)';
        }

        if (config.resendApiKey === '***configured***') {
          document.getElementById('resend-key').classList.add('configured');
          document.getElementById('resend-key').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (already configured)';
          document.getElementById('email-collapsible-status').textContent = 'Configured';
          document.getElementById('email-collapsible-status').classList.add('configured');
        }

        if (config.userEmail) {
          document.getElementById('user-email').value = config.userEmail;
        }

        if (config.emailDomain) {
          document.getElementById('email-domain').value = config.emailDomain;
        }

        if (config.twilioSid) {
          document.getElementById('twilio-sid').value = config.twilioSid;
          document.getElementById('whatsapp-collapsible-status').textContent = 'Configured';
          document.getElementById('whatsapp-collapsible-status').classList.add('configured');
        }

        if (config.twilioToken === '***configured***') {
          document.getElementById('twilio-token').classList.add('configured');
          document.getElementById('twilio-token').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (already configured)';
        }

        if (config.twilioWhatsApp) {
          document.getElementById('twilio-whatsapp').value = config.twilioWhatsApp;
        }

        if (config.userWhatsApp) {
          document.getElementById('user-whatsapp').value = config.userWhatsApp;
        }

        if (config.todoistApiKey === '***configured***') {
          document.getElementById('todoist-key').classList.add('configured');
          document.getElementById('todoist-key').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (already configured)';
          document.getElementById('todoist-collapsible-status').textContent = 'Configured';
          document.getElementById('todoist-collapsible-status').classList.add('configured');
        }

        if (config.timezone && config.timezone !== 'UTC') {
          document.getElementById('timezone').value = config.timezone;
        } else {
          // Auto-detect timezone
          try {
            const detected = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const tzSelect = document.getElementById('timezone');
            if ([...tzSelect.options].some(o => o.value === detected)) {
              tzSelect.value = detected;
            }
          } catch (e) {}
        }

        if (config.play) {
          selectPlay(config.play);
        }

        // Load ICS feeds
        if (config.icsFeeds && Array.isArray(config.icsFeeds)) {
          config.icsFeeds.forEach(feed => {
            addICSFeed(feed.name, feed.url);
          });
        }

        updateLLMFields();
      } catch (e) {
        console.error('Failed to load config:', e);
      }
    }

    // Google OAuth
    async function checkGoogleStatus() {
      try {
        const res = await fetch('/api/google/status');
        const data = await res.json();

        if (data.connected) {
          // Show connected state, hide setup
          document.getElementById('google-connected').style.display = 'block';
          document.getElementById('google-setup').style.display = 'none';
          document.getElementById('google-email').textContent = data.email || 'Connected';

          const badge = document.querySelector('#google-section .section-badge');
          if (badge) {
            badge.textContent = 'Connected';
            badge.classList.remove('optional');
          }
        } else if (data.configured) {
          // Credentials saved but not signed in - show sign in button
          document.getElementById('google-connected').style.display = 'none';
          document.getElementById('google-setup').style.display = 'block';
          document.getElementById('google-step-1').style.display = 'none';
          document.getElementById('google-step-2').innerHTML = `
            <button class="btn btn-primary" onclick="connectGoogle()" style="width: 100%;">
              <span style="margin-right: 8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle;">
                  <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
              </span>
              Sign in with Google
            </button>
          `;
        } else {
          // Not configured - show full setup
          document.getElementById('google-connected').style.display = 'none';
          document.getElementById('google-setup').style.display = 'block';
        }
      } catch (e) {
        console.error('Failed to check Google status:', e);
      }
    }

    async function saveGoogleCredentials() {
      const clientId = document.getElementById('google-client-id').value.trim();
      const clientSecret = document.getElementById('google-client-secret').value.trim();
      const status = document.getElementById('google-status');
      const btn = document.getElementById('google-save-btn');

      if (!clientId || !clientSecret) {
        status.textContent = 'Please enter both Client ID and Secret';
        status.className = 'status-msg error';
        return;
      }

      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        const res = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            googleClientId: clientId,
            googleClientSecret: clientSecret,
          })
        });

        if (res.ok) {
          status.textContent = 'Saved! Opening Google sign-in...';
          status.className = 'status-msg success';

          // Small delay then open OAuth
          setTimeout(() => {
            connectGoogle();
          }, 500);
        } else {
          throw new Error('Failed to save');
        }
      } catch (e) {
        status.textContent = 'Failed to save credentials';
        status.className = 'status-msg error';
        btn.textContent = 'Save & Connect Google';
        btn.disabled = false;
      }
    }

    function connectGoogle() {
      const width = 500;
      const height = 600;
      const left = (window.innerWidth - width) / 2;
      const top = (window.innerHeight - height) / 2;

      const popup = window.open(
        '/auth/google',
        'google-oauth',
        `width=${width},height=${height},left=${left},top=${top}`
      );

      const checkClosed = setInterval(() => {
        if (popup.closed) {
          clearInterval(checkClosed);
          checkGoogleStatus();
        }
      }, 500);
    }

    async function disconnectGoogle() {
      if (!confirm('Disconnect Google account?')) return;

      try {
        await fetch('/api/google/disconnect', { method: 'POST' });
        document.getElementById('google-connected').style.display = 'none';
        document.getElementById('google-setup').style.display = 'block';

        const badge = document.querySelector('#google-section .section-badge');
        if (badge) {
          badge.textContent = 'Optional';
          badge.classList.add('optional');
        }

        checkGoogleStatus();
      } catch (e) {
        console.error('Failed to disconnect:', e);
      }
    }

    // Initialize
    loadExistingConfig();
    checkGoogleStatus();

    // Info popup system
    const infoContent = {
      llm: {
        title: 'üß† Getting an LLM API Key',
        steps: {
          kimi: [
            'Go to <a href="https://platform.moonshot.ai/console/api-keys" target="_blank">platform.moonshot.ai</a>',
            'Sign up or log in with your account',
            'Click "Create API Key"',
            'Copy the key and paste it below'
          ],
          openai: [
            'Go to <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a>',
            'Sign up or log in with your account',
            'Click "Create new secret key"',
            'Give it a name and copy the key'
          ],
          anthropic: [
            'Go to <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>',
            'Sign up or log in with your account',
            'Click "Create Key"',
            'Copy the key and paste it below'
          ]
        }
      },
      telegram: {
        title: 'üí¨ Creating a Telegram Bot',
        steps: [
          'Open Telegram and search for <code>@BotFather</code>',
          'Start a chat and send <code>/newbot</code>',
          'Choose a name for your bot (e.g., "My Sonder Bot")',
          'Choose a username ending in "bot" (e.g., "mysonder_bot")',
          'Copy the token BotFather gives you'
        ]
      },
      resend: {
        title: 'üìß Setting up Resend Email',
        steps: [
          'Go to <a href="https://resend.com" target="_blank">resend.com</a> and sign up',
          'Add and verify your domain in Settings ‚Üí Domains',
          'Go to API Keys and click "Create API Key"',
          'Copy the key (starts with <code>re_</code>)'
        ]
      },
      twilio: {
        title: 'üì± Setting up Twilio WhatsApp',
        steps: [
          'Go to <a href="https://console.twilio.com" target="_blank">console.twilio.com</a> and sign up',
          'Find your Account SID and Auth Token on the dashboard',
          'Go to Messaging ‚Üí Try it out ‚Üí Send a WhatsApp message',
          'Follow steps to connect your WhatsApp to the Twilio sandbox',
          'Use the sandbox number (usually +14155238886) as Twilio WhatsApp Number'
        ]
      },
      todoist: {
        title: '‚úÖ Getting a Todoist API Key',
        steps: [
          'Go to <a href="https://todoist.com/app/settings/integrations/developer" target="_blank">Todoist Settings ‚Üí Integrations ‚Üí Developer</a>',
          'Scroll down to "API token"',
          'Copy your token'
        ]
      },
      calendar: {
        title: 'üìÖ Adding Calendar Feeds',
        steps: [
          '<strong>Google Calendar:</strong> Settings (gear) ‚Üí Select calendar ‚Üí Integrate calendar ‚Üí "Secret address in iCal format"',
          '<strong>Apple Calendar:</strong> Right-click calendar ‚Üí Share ‚Üí Public Calendar ‚Üí Copy Link',
          '<strong>Outlook:</strong> Settings ‚Üí Calendar ‚Üí Shared calendars ‚Üí Publish a calendar ‚Üí ICS link',
          'Paste the URL and give it a name to identify it'
        ]
      },
      google: {
        title: 'Setting up Google OAuth',
        steps: [
          'Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>',
          'Create a new project (or select existing)',
          '<strong>Enable APIs</strong> ‚Äî Go to <strong>APIs & Services ‚Üí Library</strong> and enable these 3 APIs:',
          '&nbsp;&nbsp;&nbsp;‚Ä¢ <a href="https://console.cloud.google.com/apis/library/calendar-json.googleapis.com" target="_blank">Google Calendar API</a>',
          '&nbsp;&nbsp;&nbsp;‚Ä¢ <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank">Gmail API</a>',
          '&nbsp;&nbsp;&nbsp;‚Ä¢ <a href="https://console.cloud.google.com/apis/library/tasks.googleapis.com" target="_blank">Google Tasks API</a>',
          'Go to <strong>APIs & Services ‚Üí OAuth consent screen</strong>, choose "External", fill in app name',
          'Add yourself as a <strong>Test User</strong> (your email)',
          'Go to <strong>Credentials ‚Üí Create Credentials ‚Üí OAuth Client ID</strong>',
          'Choose "Web application", add redirect URI: <code>http://localhost:3000/auth/google/callback</code>',
          'Copy the Client ID and Client Secret, paste them below',
          '<em>Note: Sonder only reads your calendar/emails and creates events. It never deletes anything.</em>'
        ]
      }
    };

    function showInfo(type) {
      const info = infoContent[type];
      if (!info) return;

      let steps = info.steps;

      // For LLM, get provider-specific steps
      if (type === 'llm') {
        const provider = document.getElementById('llm-provider').value;
        if (provider === 'ollama') {
          alert('Ollama runs locally - no API key needed! Just make sure Ollama is running.');
          return;
        }
        steps = info.steps[provider] || info.steps.openai;
      }

      const stepsHtml = steps.map(s => `<li>${s}</li>`).join('');

      document.getElementById('info-popup-title').innerHTML = info.title;
      document.getElementById('info-popup-steps').innerHTML = stepsHtml;
      document.getElementById('info-overlay').classList.add('active');
      document.getElementById('info-popup').classList.add('active');
    }

    function closeInfo() {
      document.getElementById('info-overlay').classList.remove('active');
      document.getElementById('info-popup').classList.remove('active');
    }

    // Close on overlay click
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('info-overlay')?.addEventListener('click', closeInfo);
    });
  </script>

  <!-- Info popup -->
  <div class="info-overlay" id="info-overlay"></div>
  <div class="info-popup" id="info-popup">
    <button class="close-btn" onclick="closeInfo()">&times;</button>
    <h3 id="info-popup-title"></h3>
    <ol id="info-popup-steps"></ol>
  </div>
</body>
</html>
